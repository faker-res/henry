<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>


</head>
<body>
<script type = "text/javascript">

    function getQueryVariable(variable) {
        let query = window.location.search.substring(1);
        let vars = query.split("&");
        for (let i=0;i<vars.length;i++) {
            let pair = vars[i].split("=");

            if(pair[0] == variable){return pair[1].replace(/\%22/g,"");}
        }
        return(false);
    }

    let returnedCode = null;
    let curLocation = location;
    if ("WebSocket" in window) {

        let domain = window.location.toString().replace(/\%22/g,"");
        returnedCode = getQueryVariable("code");

        // Let us open a web socket
        var ws = new WebSocket("ws://cstest-eu.neweb.me/websocket");

        ws.onopen = function() {
            // Web Socket is connected, send data using send()

            if (returnedCode){
                let json = JSON.stringify({service: "dxmission", functionName: "submitDXCode", data: {code: returnedCode, domain: domain}});
                ws.send(json);
            }

        };

        ws.onmessage = function (evt) {
            if (evt.data){
                let receivedMsg = JSON.parse(evt.data);
                console.log("returned message",receivedMsg)
                if (receivedMsg.data.data && receivedMsg.data.data.redirect){
                    // redirect to the desired link
//                    window.location.href = receivedMsg.data.data.redirect;
                    curLocation.assign(receivedMsg.data.data.redirect);
                }
            }

        };

        ws.onclose = function() {
            // websocket is closed.
            alert("Connection is closed...");
        };
    } else {

        // The browser doesn't support WebSocket
        alert("WebSocket NOT supported by your Browser!");
    }

</script>
</body>
</html>
