const http=require("http");const url=require("url");const fs=require("fs");const path=require("path");const env=require("./config/env").config();const cred=require("./config/cred");const theOtherEnv=require("./config/env").getAnotherConfig()[0];const webEnv=require("./public/js/webEnv");const nodeUrl=env.redisUrl||"localhost";const port=env.redisPort||1802;const jwt=require("jsonwebtoken");const secret="$ap1U5eR$";const crypto=require("crypto");const rp=require("request-promise");const privateKeyPath="./public/playerPhone.key.pem";const replacedPrivateKeyPath="./public/playerPhone.key.pem.bak";const publicKeyPath="./public/playerPhone.pub";const replacedPublicKeyPath="./public/playerPhone.pub.bak";const restartFPMSPath="./public/restartFPMS";const fpmsKey="Fr0m_FPM$!";const testKeyPairText="TEST ENCRYPTION";const ts=jwt.sign(fpmsKey,secret);const uh=crypto.createHash("md5").update(env.redisUrl).digest("hex");let privateKey,publicKey,replacedPrivateKey,replacedPublicKey;http.createServer(function(e,t){console.log(`${e.method} ${e.url}`);t.setHeader("Access-Control-Allow-Origin","*");t.setHeader("Access-Control-Request-Method","*");t.setHeader("Access-Control-Allow-Methods","POST, GET, OPTIONS");t.setHeader("Access-Control-Allow-Headers","*");t.setHeader("Access-Control-Expose-Headers","Location");const r=url.parse(e.url,true);let n=`./public${r.pathname}`;let o=r.query;if(e.method==="POST"){if(e.headers&&e.headers["x-token"]){jwt.verify(e.headers["x-token"],env.socketSecret,function(r,o){if(r||!o){console.log("jwt verify error - POST",e.headers["x-token"],env.socketSecret,r);s()}else{console.log(`${o.adminName} ${e.method} ${e.url}`);let r=[];let s,c,i,a,l;switch(n){case publicKeyPath:console.log("SAVING IN EFFECT KEY PAIR");e.on("data",e=>{r.push(e)}).on("end",()=>{s=Buffer.concat(r);try{c=JSON.parse(s.toString());if(!c||!c.privateKey||!c.publicKey){t.end("Invalid RSA Key Pair!")}else{i=crypto.privateEncrypt(c.privateKey,Buffer.from(testKeyPairText,"utf8"));a=crypto.publicDecrypt(c.publicKey,i);l=a.toString();if(l===testKeyPairText){privateKey=c.privateKey;publicKey=c.publicKey;t.end("Success")}else{t.end("Invalid RSA Key Pair!")}}}catch(e){console.log("error",e);t.end("Invalid RSA Key Pair!")}});break;case replacedPublicKeyPath:console.log("SAVING REPLACED KEY PAIR");e.on("data",e=>{r.push(e)}).on("end",()=>{s=Buffer.concat(r);try{c=JSON.parse(s.toString());if(!c||!c.privateKey||!c.publicKey){t.end("Invalid RSA Key Pair!")}else{i=crypto.privateEncrypt(c.privateKey,Buffer.from(testKeyPairText,"utf8"));a=crypto.publicDecrypt(c.publicKey,i);l=a.toString();if(l===testKeyPairText){replacedPrivateKey=c.privateKey;replacedPublicKey=c.publicKey;t.end("Success")}else{t.end("Invalid RSA Key Pair!")}}}catch(e){console.log("error",e);t.end("Invalid RSA Key Pair!")}});break;case restartFPMSPath:console.log("REQUEST TO RESTART FPMS");rp({method:"POST",uri:env.fpmsUpdateKeyAddress,body:{token:jwt.sign("Restart server",env.socketSecret),privateKey:Boolean(privateKey),publicKey:Boolean(publicKey),replPrivateKey:Boolean(replacedPrivateKey),replPublicKey:Boolean(replacedPublicKey)},json:true}).then(()=>{t.end("Success")});break}}})}else{let r=[];let n;e.on("data",e=>{r.push(e)}).on("end",()=>{n=Buffer.concat(r);try{let e=JSON.parse(n.toString());if(e.username&&e.password){let r=cred.getAdmin(e.username.toLowerCase());if(!r){t.end(JSON.stringify({success:false,error:{name:"InvalidPassword",message:"Wrong credential!"}}))}else if(!validateHash(r.password,e.password)){t.end(JSON.stringify({success:false,error:{name:"InvalidPassword",message:"Password or user name is not correct!"}}))}else{let e={adminInfo:r,loginTime:new Date};t.end(JSON.stringify({success:true,token:jwt.sign(e,env.socketSecret)}))}}}catch(e){console.log("error",e);t.end(JSON.stringify({success:false,error:{name:"InvalidPassword",message:"Error occured!"}}))}})}}else if(e.method==="GET"){switch(n){case privateKeyPath:c(o,t,privateKey);break;case replacedPrivateKeyPath:c(o,t,replacedPrivateKey);break;case publicKeyPath:c(o,t,publicKey);break;case replacedPublicKeyPath:c(o,t,replacedPublicKey);break;case"./public/login.html":i(n,t);break;case"./public/static.html":if(o&&o.token){jwt.verify(o.token,env.socketSecret,function(r,o){if(r||!o){console.log("jwt verify error",r);s()}else{console.log(`${o.adminName} ${e.method} ${e.url}`);i(n,t)}})}else{s()}break;case"./public/static.htm":case"./":s();break;default:i(n,t)}}else if(e.method==="OPTIONS"){t.end()}function s(){t.writeHead(302,{location:"/login.html"});t.end()}function c(e,t,r){if(e&&e.token){jwt.verify(e.token,secret,(n,o)=>{if(!n&&o&&o===fpmsKey){t.end(uh)}if(n&&e.token){const n=e.token.split(":");const o=Buffer.from(n.shift(),"hex");const s=Buffer.from(n.join(":"),"hex");const c=crypto.createDecipheriv("aes-256-ctr",uh,o);let i=c.update(s,"hex","utf8");i+=c.final("utf8");if(i===fpmsKey){t.end(r)}else{t.end()}}})}else{s()}}function i(e,t){const r=path.parse(e).ext;const n={".ico":"image/x-icon",".html":"text/html",".js":"text/javascript",".json":"application/json",".css":"text/css",".png":"image/png",".jpg":"image/jpeg",".wav":"audio/wav",".mp3":"audio/mpeg",".svg":"image/svg+xml",".pdf":"application/pdf",".doc":"application/msword"};fs.exists(e,function(o){console.log("exist",o);if(!o){e="public/login.html"}fs.readFile(e,function(e,o){if(e){t.statusCode=500;t.end(`Error getting the file: ${e}.`)}else{t.setHeader("Content-type",n[r]||"text/plain");t.end(o)}})})}}).listen(parseInt(port));getKeyFromOtherInstance();function getKeyFromOtherInstance(){let e=privateKey?Promise.resolve(privateKey):o();let t=replacedPrivateKey?Promise.resolve(replacedPrivateKey):s();let r=publicKey?Promise.resolve(publicKey):c();let n=replacedPublicKey?Promise.resolve(replacedPublicKey):i();return Promise.all([e,t,r,n]);function o(){return rp(a("playerPhone.key.pem",ts)).then(e=>{if(e){let t=cred.getHash(env.redisUrl);if(t===e){let e=cred.getCipherIV(t,fpmsKey);return rp(a("playerPhone.key.pem",e))}}}).then(e=>{if(e){console.log("SETTING PRIVATE KEY FROM ANOTHER INSTANCE");privateKey=e}}).catch(e=>privateKey)}function s(){return rp(a("playerPhone.key.pem.bak",ts)).then(e=>{if(e){let t=cred.getHash(env.redisUrl);if(t===e){let e=cred.getCipherIV(t,fpmsKey);return rp(a("playerPhone.key.pem.bak",e))}}}).then(e=>{if(e){console.log("SETTING REPL PRIVATE KEY FROM ANOTHER INSTANCE");replacedPrivateKey=e}}).catch(e=>replacedPrivateKey)}function c(){return rp(a("playerPhone.pub",ts)).then(e=>{if(e){let t=cred.getHash(env.redisUrl);if(t===e){let e=cred.getCipherIV(t,fpmsKey);return rp(a("playerPhone.pub",e))}}}).then(e=>{if(e){console.log("SETTING PUBLIC KEY FROM ANOTHER INSTANCE");publicKey=e}}).catch(e=>publicKey)}function i(){return rp(a("playerPhone.pub.bak",ts)).then(e=>{if(e){let t=cred.getHash(env.redisUrl);if(t===e){let e=cred.getCipherIV(t,fpmsKey);return rp(a("playerPhone.pub.bak",e))}}}).then(e=>{if(e){console.log("SETTING REPL PUBLIC KEY FROM ANOTHER INSTANCE");replacedPublicKey=e}}).catch(e=>replacedPublicKey)}function a(e,t){let r="http://".concat(theOtherEnv.redisUrl);if(theOtherEnv.redisPort){r+=":"+theOtherEnv.redisPort}r+="/";r+=e;r+="?token=";r+=t;return r}}function validateHash(e,t){let r=crypto.createHash("md5").update(t).digest("hex");return e===r}console.log(`Server listening on port ${port}`);