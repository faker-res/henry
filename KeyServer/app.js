const http=require("http"),url=require("url"),env=require("./config/env").config(),cred=require("./config/cred"),theOtherEnv=require("./config/env").getAnotherConfig()[0],port=env.redisPort||1802,jwt=require("jsonwebtoken"),secret="$ap1U5eR$",crypto=require("crypto"),rp=require("request-promise"),privateKeyPath="./public/playerPhone.key.pem",replacedPrivateKeyPath="./public/playerPhone.key.pem.bak",publicKeyPath="./public/playerPhone.pub",replacedPublicKeyPath="./public/playerPhone.pub.bak",restartFPMSPath="./public/restartFPMS",fpmsKey="Fr0m_FPM$!",testKeyPairText="TEST ENCRYPTION",ts=jwt.sign(fpmsKey,secret),uh=crypto.createHash("md5").update(env.redisUrl).digest("hex");let privateKey,publicKey,replacedPrivateKey,replacedPublicKey;function getKeyFromOtherInstance(){let e=privateKey?Promise.resolve(privateKey):rp(a("playerPhone.key.pem",ts)).then(e=>{if(e){let r=cred.getHash(env.redisUrl);if(r===e){let e=cred.getCipherIV(r,fpmsKey);return rp(a("playerPhone.key.pem",e))}}}).then(e=>{e&&(console.log("SETTING PRIVATE KEY FROM ANOTHER INSTANCE"),privateKey=e)}).catch(e=>privateKey),r=replacedPrivateKey?Promise.resolve(replacedPrivateKey):rp(a("playerPhone.key.pem.bak",ts)).then(e=>{if(e){let r=cred.getHash(env.redisUrl);if(r===e){let e=cred.getCipherIV(r,fpmsKey);return rp(a("playerPhone.key.pem.bak",e))}}}).then(e=>{e&&(console.log("SETTING REPL PRIVATE KEY FROM ANOTHER INSTANCE"),replacedPrivateKey=e)}).catch(e=>replacedPrivateKey),t=publicKey?Promise.resolve(publicKey):rp(a("playerPhone.pub",ts)).then(e=>{if(e){let r=cred.getHash(env.redisUrl);if(r===e){let e=cred.getCipherIV(r,fpmsKey);return rp(a("playerPhone.pub",e))}}}).then(e=>{e&&(console.log("SETTING PUBLIC KEY FROM ANOTHER INSTANCE"),publicKey=e)}).catch(e=>publicKey),i=replacedPublicKey?Promise.resolve(replacedPublicKey):rp(a("playerPhone.pub.bak",ts)).then(e=>{if(e){let r=cred.getHash(env.redisUrl);if(r===e){let e=cred.getCipherIV(r,fpmsKey);return rp(a("playerPhone.pub.bak",e))}}}).then(e=>{e&&(console.log("SETTING REPL PUBLIC KEY FROM ANOTHER INSTANCE"),replacedPublicKey=e)}).catch(e=>replacedPublicKey);return Promise.all([e,r,t,i]);function a(e,r){let t=theOtherEnv.redisUrl;return theOtherEnv.redisPort&&(t+=":"+theOtherEnv.redisPort),t+="/",t+=e,t+="?token=",t+=r}}function validateHash(e,r){return e===crypto.createHash("md5").update(r).digest("hex")}http.createServer(function(e,r){console.log(`${e.method} ${e.url}`),r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Request-Method","*"),r.setHeader("Access-Control-Allow-Methods","POST, GET, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","*"),r.setHeader("Access-Control-Expose-Headers","Location");const t=url.parse(e.url,!0);let i=`./public${t.pathname}`,a=t.query;if("POST"===e.method)e.headers&&e.headers["x-token"]&&jwt.verify(e.headers["x-token"],env.socketSecret,function(t,a){if(t||!a)console.log("jwt verify error - POST",e.headers["x-token"],env.socketSecret,t),o();else{console.log(`${a.adminName} ${e.method} ${e.url}`);let t,o,n,c,l,s=[];switch(i){case publicKeyPath:console.log("SAVING IN EFFECT KEY PAIR"),e.on("data",e=>{s.push(e)}).on("end",()=>{t=Buffer.concat(s);try{if((o=JSON.parse(t.toString()))&&o.privateKey&&o.publicKey)if(n=crypto.privateEncrypt(o.privateKey,Buffer.from(testKeyPairText,"utf8")),c=crypto.publicDecrypt(o.publicKey,n),(l=c.toString())===testKeyPairText)if(privateKey=o.privateKey,publicKey=o.publicKey,theOtherEnv&&theOtherEnv.redisUrl&&!o.isFromAnotherInstance){let t=theOtherEnv.redisUrl;theOtherEnv.redisPort&&(t+=":"+theOtherEnv.redisPort),t+=e.url,rp({method:"POST",uri:t,headers:{"x-token":e.headers["x-token"]},body:{privateKey:privateKey,publicKey:publicKey,isFromAnotherInstance:!0},json:!0}).then(()=>{r.end("Success")})}else r.end("Success");else r.end("Invalid RSA Key Pair!");else r.end("Invalid RSA Key Pair!")}catch(e){console.log("error",e),r.end("Invalid RSA Key Pair!")}});break;case replacedPublicKeyPath:console.log("SAVING REPLACED KEY PAIR"),e.on("data",e=>{s.push(e)}).on("end",()=>{t=Buffer.concat(s);try{if((o=JSON.parse(t.toString()))&&o.privateKey&&o.publicKey)if(n=crypto.privateEncrypt(o.privateKey,Buffer.from(testKeyPairText,"utf8")),c=crypto.publicDecrypt(o.publicKey,n),(l=c.toString())===testKeyPairText)if(replacedPrivateKey=o.privateKey,replacedPublicKey=o.publicKey,theOtherEnv&&theOtherEnv.redisUrl&&!o.isFromAnotherInstance){let t=theOtherEnv.redisUrl;theOtherEnv.redisPort&&(t+=":"+theOtherEnv.redisPort),t+=e.url,rp({method:"POST",uri:t,headers:{"x-token":e.headers["x-token"]},body:{privateKey:replacedPrivateKey,publicKey:replacedPublicKey,isFromAnotherInstance:!0},json:!0}).then(()=>{r.end("Success")})}else r.end("Success");else r.end("Invalid RSA Key Pair!");else r.end("Invalid RSA Key Pair!")}catch(e){console.log("error",e),r.end("Invalid RSA Key Pair!")}});break;case restartFPMSPath:console.log("REQUEST TO RESTART FPMS"),rp({method:"POST",uri:env.fpmsUpdateKeyAddress,body:{token:jwt.sign("Restart server",env.socketSecret),privateKey:Boolean(privateKey),publicKey:Boolean(publicKey),replPrivateKey:Boolean(replacedPrivateKey),replPublicKey:Boolean(replacedPublicKey)},json:!0}).then(()=>{r.end("Success")})}}});else if("GET"===e.method)switch(i){case privateKeyPath:n(a,r,privateKey);break;case replacedPrivateKeyPath:n(a,r,replacedPrivateKey);break;case publicKeyPath:n(a,r,publicKey);break;case replacedPublicKeyPath:n(a,r,replacedPublicKey)}else"OPTIONS"===e.method?r.end():"HEAD"===e.method&&privateKey&&publicKey&&r.end("ok");function o(){r.writeHead(302,{location:"/login.html"}),r.end()}function n(e,r,t){e&&e.token?jwt.verify(e.token,secret,(i,a)=>{if(!i&&a&&a===fpmsKey&&r.end(uh),i&&e.token){const i=e.token.split(":"),a=Buffer.from(i.shift(),"hex"),o=Buffer.from(i.join(":"),"hex"),n=crypto.createDecipheriv("aes-256-ctr",uh,a);let c=n.update(o,"hex","utf8");(c+=n.final("utf8"))===fpmsKey?r.end(t):r.end()}}):o()}}).listen(parseInt(port)),getKeyFromOtherInstance(),console.log(`Server listening on port ${port}`);